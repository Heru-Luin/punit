#!/usr/bin/env php
<?php

// Make sure the current working directory is the project root directory
chdir(dirname(dirname(__FILE__)));

$config = getConfig();

require $config['punit']['bootstrap'];

$classes = [
    Test\App\CalcTest::class => [],
    Test\App\AssertTest::class => [],
];

fillClassMethods($config, $classes);

$stack = [];
$i = 1;
$pass = 0;
$fail = 0;
foreach($classes as $class => $methods) {
    foreach($methods as $method) {
        try {
            (new $class())->$method();
            $stack[$class][$method]['result'] = true;
            
            $pass++;

            if ($config['punit']['colors']) {
                echo "$i) $class::$method() --> \033[32m PASS \033[0m" . PHP_EOL;
            } else {
                echo "$i) $class::$method() --> PASS" . PHP_EOL;
            }
        } catch(\Exception $e) {
            $stack[$class][$method]['result'] = false;
            $stack[$class][$method]['stack'] = $e;
            
            $fail++;
            
            if ($config['punit']['colors']) {
                echo "$i) $class::$method() --> \033[31m FAIL";
            } else {
                echo "$i) $class::$method() --> FAIL";
            }
            // If verbose, print exception message
            if ($config['punit']['verbose']) {
                echo "Error: ".$e->getMessage();
            }
            if ($config['punit']['colors']) {
                echo " \033[0m ";
            }
            echo PHP_EOL;
            if ($config['punit']['stop_on_failure']) {
                break 2;
            }
        } 
        
        $i++;         
    }   
}

if ($config['punit']['colors']) {
    echo PHP_EOL . "\033[34m Tests: ".($pass+$fail)."\033[0m \033[32m Ok: $pass \033[0m \033[31m Failures: $fail \033[0m" . PHP_EOL;
} else {
    echo PHP_EOL . "Tests: ".($pass+$fail)." Ok: $pass Failures: $fail" . PHP_EOL;
}

//------------------------------------------
// Configuration
//------------------------------------------

function getConfig()
{
    $config = [];

    foreach (['punit.php.dist', 'punit.php'] as $fileName) {
        if (file_exists($fileName)) {
            $config = array_replace_recursive($config, require_once($fileName));
        }
    }
    return $config;
}

function fillClassMethods(array $config, array &$classes)
{
    foreach ($classes as $className => &$methodNames) {
        foreach (get_class_methods($className) as $methodName) {
            if (startsWith($methodName, $config['punit']['method']['prefix'].'') &&
                endsWith($methodName, $config['punit']['method']['suffix'].'')) {
                $methodNames[] = $methodName;
            }
        }
    }
}

//------------------------------------------
// Assertions
//------------------------------------------

// Array

function assertArrayHasKey(array &$array, $key)
{
    if (!isset($array[$key]) && !array_key_exists($key, $array)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertArrayHasKeys(array &$array, array $keys)
{
    foreach ($keys as $key) {
        assertArrayHasKey($array, $key);
    }
}

function assertArrayHasSize(array $array, int $size)
{
    if (count($array) !== $size) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

// Directory

function assertDirectoryExists(string $path)
{
    if (!is_dir($path)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertDirectoryIsReadable(string $path)
{
    if (!is_dir($path) || !is_readable($path)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertDirectoryIsWritable(string $path)
{
    if (!is_dir($path) || !is_writable($path)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

// File

function assertFileExists(string $path)
{
    if (!is_file($path)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertFileEquals(string $path, string $content)
{
    if (!is_file($path) || file_get_contents($path) !== $content) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertFileIsReadable(string $path)
{
    if (!is_file($path) || !is_readable($path)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertFileIsWritable(string $path)
{
    if (!is_file($path) || !is_writable($path)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

// Comparaison

function assertEmpty($variable)
{
    if (!empty($variable)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertEquals($variable, $data)
{
    if ($variable !== $data) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertFalse($variable)
{
    if (false !== $variable) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertTrue($variable)
{
    if (true !== $variable) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertGreaterThan($variable, $data)
{
    if ($variable <= $data) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertGreaterThanOrEqual($variable, $data)
{
    if ($variable < $data) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

// Object

function assertInstanceOf($variable, $data)
{
    if (!($variable instanceof $data)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertNull($variable)
{
    if (null !== $variable) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertObjectHasAttribute($object, $attribute)
{
    if (!property_exists($object, $attribute)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

// String

function assertRegExp($str, $regex)
{
    if (!preg_match($regex, $str)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertStringEndsWith($str, $needle)
{
    if (!endsWith($str, $needle)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}

function assertStringStartsWith($str, $needle)
{
    if (!startsWith($str, $needle)) {
        throw new \Exception(__FUNCTION__.' failed.');
    }
}


/**
 * Checks if a string starts with $needle.
 *
 * @param string $str The string to search in.
 * @param string $needle The searched string.
 * @return bool true if $str starts with $needle, false otherwise.
 */
function startsWith(string $str, string $needle): bool
{
    return $needle === substr($str, 0, strlen($needle));
}

/**
 * Checks if a string ends with $needle.
 *
 * @param string $str The string to search in.
 * @param string $needle The searched string.
 * @return bool true if $str ends with $needle, false otherwise.
 */
function endsWith(string $str, string $needle): bool
{
    $needleLen = strlen($needle);
    return $needleLen ? $needle === substr($str, -$needleLen) : true;
}